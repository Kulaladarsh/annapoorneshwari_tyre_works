<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <title>{{ service_name }} - Service Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding-top: 80px;
      min-height: 100vh;
    }

    .container { max-width: 1000px; }

    .service-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    .service-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    .review-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      overflow: hidden;
      position: relative;
      border-left: 4px solid #667eea;
    }

    .review-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .review-user-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .review-user {
      font-weight: 700;
      font-size: 1rem;
      color: #333;
      display: flex;
      align-items: center;
    }

    .review-date {
      color: #888;
      font-size: 0.85rem;
      margin-left: 1.5rem;
    }

    .review-rating {
      color: #ffc107;
      font-size: 1rem;
      letter-spacing: 2px;
      font-weight: 600;
    }

    .review-rating i {
      margin-right: 2px;
    }

    .review-comment {
      color: #555;
      line-height: 1.7;
      margin: 0.75rem 0;
      font-size: 0.95rem;
    }

    .review-photos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 1rem;
    }

    .review-photos img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid #e0e0e0;
    }

    .review-photos img:hover {
      transform: scale(1.08);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .review-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 0.75rem 0;
    }

    .no-reviews {
      text-align: center;
      padding: 3rem;
      color: white;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
    }

    .image-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      transition: transform 0.3s ease;
      cursor: zoom-out;
    }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 40px;
      color: white;
      font-size: 40px;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-modal-close:hover {
      background: rgba(0,0,0,0.8);
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .review-photos { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
      .review-photos img { height: 100px; }
      .review-header { gap: 0.5rem; }
    }

    .rating-form {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .rating-form h3 {
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .rating-stars {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1rem;
    }

    .rating-stars input[type="radio"] {
      display: none;
    }

    .rating-stars label {
      font-size: 2rem;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s;
    }

    .rating-stars input[type="radio"]:checked ~ label,
    .rating-stars label:hover,
    .rating-stars label:hover ~ label {
      color: #ffc107;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .file-upload {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: rgba(102, 126, 234, 0.05);
      cursor: pointer;
      transition: background 0.3s;
    }

    .file-upload-label:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .file-upload-label i {
      margin-right: 0.5rem;
      color: #667eea;
    }

    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }

    .file-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .remove-file {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4757;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
    }

    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .rating-summary {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .rating-summary h3 {
      color: #333;
      font-weight: 700;
      font-size: 1.3rem;
    }

    .rating-bars {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .rating-bar-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .star-label {
      min-width: 100px;
      color: #ffc107;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .bar-container {
      flex: 1;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .count-label {
      min-width: 30px;
      text-align: right;
      color: #666;
      font-size: 0.9rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="service-header">
      <h1>{{ service_name }}</h1>
    </div>

    <!-- Rating Form - Only show to logged-in users who haven't rated yet -->
    {% if can_rate and session.get('user_name') %}
      {% set user_has_rated = false %}
      {% for review in ratings %}
        {% if review.user_name == session.get('user_name') and review.service_name == service_name %}
          {% set user_has_rated = true %}
        {% endif %}
      {% endfor %}
      
      {% if not user_has_rated %}
    <div class="rating-form">
      <h3><i class="fas fa-star me-2"></i>Rate This Service</h3>

      <form id="ratingForm" enctype="multipart/form-data">
        <input type="hidden" name="service_name" value="{{ service_name }}">
        <input type="hidden" name="user_name" value="{{ session.get('user_name', '') }}">

        <div class="form-group">
          <label for="booking_id">Select Booking</label>
          <select name="booking_id" id="booking_id" required>
            <option value="">Choose a booking...</option>
            {% for booking in bookings %}
            <option value="{{ booking.booking_id }}">{{ booking.booking_id }} - {{ booking.preferred_date or 'N/A' }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Rating</label>
          <div class="rating-stars">
            <input type="radio" id="star5" name="rating" value="5" required>
            <label for="star5"><i class="fas fa-star"></i></label>
            <input type="radio" id="star4" name="rating" value="4">
            <label for="star4"><i class="fas fa-star"></i></label>
            <input type="radio" id="star3" name="rating" value="3">
            <label for="star3"><i class="fas fa-star"></i></label>
            <input type="radio" id="star2" name="rating" value="2">
            <label for="star2"><i class="fas fa-star"></i></label>
            <input type="radio" id="star1" name="rating" value="1">
            <label for="star1"><i class="fas fa-star"></i></label>
          </div>
        </div>

        <div class="form-group">
          <label for="comment">Comment (Optional)</label>
          <textarea name="comment" id="comment" rows="4" placeholder="Share your experience..."></textarea>
        </div>

        <div class="form-group">
          <label>Upload Photos (Optional)</label>
          <div class="file-upload">
            <input type="file" id="photos" name="photos" accept="image/*" multiple>
            <div class="file-upload-label">
              <i class="fas fa-camera"></i>
              <span>Click to select photos (max 5)</span>
            </div>
          </div>
          <div class="file-preview" id="filePreview"></div>
        </div>

        <button type="submit" class="btn-submit" id="submitBtn">
          <i class="fas fa-paper-plane me-2"></i>Submit Rating
        </button>
      </form>

      <div id="alertContainer"></div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Rating Summary Section (1-5 stars) -->
    {% if ratings and ratings|length > 0 %}
    <div class="rating-summary">
      <h3 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Rating Distribution</h3>
      <div class="rating-bars">
        {% set star_counts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0} %}
        {% for review in ratings %}
          {% if not review.comment and (not review.photo_urls or review.photo_urls|length == 0) %}
            {% set _ = star_counts.update({review.rating: star_counts[review.rating] + 1}) %}
          {% endif %}
        {% endfor %}
        
        {% for stars in range(5, 0, -1) %}
          {% set count = star_counts[stars] %}
          {% if count > 0 %}
          <div class="rating-bar-item">
            <div class="star-label">
              {% for i in range(1, stars + 1) %}<i class="fas fa-star"></i>{% endfor %}
            </div>
            <div class="bar-container">
              <div class="bar-fill" style="width: {{ (count / ratings|length * 100)|int }}%"></div>
            </div>
            <span class="count-label">{{ count }}</span>
          </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Display reviews - Flipkart Style -->
    {% if ratings and ratings|length > 0 %}
      <h3 class="mt-5 mb-4"><i class="fas fa-comments me-2"></i>Customer Reviews</h3>
      {% for review in ratings %}
        {% set has_comment = review.comment and review.comment|trim != '' %}
        {% set has_photos = review.photo_urls and review.photo_urls|length > 0 %}
        
        {% if has_comment or has_photos %}
        <div class="review-card">
          <div class="review-header">
            <div class="review-user-section">
              <span class="review-user"><i class="fas fa-user-circle me-2"></i>{{ review.user_name }}</span>
              <span class="review-date">{{ review.created_at_formatted if review.get('created_at_formatted') else '' }}</span>
            </div>
            <div class="review-rating">
              {% for i in range(1, 6) %}
                {% if i <= review.rating %}
                  <i class="fas fa-star"></i>
                {% else %}
                  <i class="far fa-star"></i>
                {% endif %}
              {% endfor %}
            </div>
          </div>

          {% if has_comment %}
            <div class="review-divider"></div>
            <div class="review-comment">
              {{ review.comment }}
            </div>
          {% endif %}

          {% if has_photos %}
            {% if has_comment %}
            <div class="review-divider"></div>
            {% endif %}
            <div class="review-photos">
              {% for photo_url in review.photo_urls %}
                <img src="{{ photo_url }}"
                     alt="Review photo by {{ review.user_name }}"
                     onclick="openImageModal('{{ photo_url }}')"
                     loading="lazy"
                     title="Click to view full size" />
              {% endfor %}
            </div>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="no-reviews">
        <i class="fas fa-star-half-alt mb-3" style="font-size: 3rem; opacity: 0.5;"></i>
        <h4>No reviews available yet</h4>
        <p>Be the first to share your experience with this service!</p>
      </div>
    {% endif %}
  </div>

  <!-- Image Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
    <img id="modalImage" src="" alt="Full size image" />
  </div>

  <script>
    function openImageModal(src) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      modalImage.src = src;
      modal.style.display = 'flex';
    }
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
      document.getElementById('modalImage').src = '';
    }

    // Get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Handle booking_id from URL
    const urlBookingId = getUrlParameter('booking_id');
    if (urlBookingId) {
      const bookingSelect = document.getElementById('booking_id');
      if (bookingSelect) {
        bookingSelect.value = urlBookingId;
        bookingSelect.style.display = 'none';
        const label = bookingSelect.previousElementSibling;
        if (label) {
          label.style.display = 'none';
        }
      }
    }

    // File upload preview
    document.getElementById('photos').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';

      files.forEach((file, index) => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.style.position = 'relative';
            div.innerHTML = `
              <img src="${e.target.result}" alt="Preview ${index + 1}">
              <span class="remove-file" onclick="removeFile(${index})">&times;</span>
            `;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        }
      });
    });

    function removeFile(index) {
      const input = document.getElementById('photos');
      const files = Array.from(input.files);
      files.splice(index, 1);

      // Create new FileList
      const dt = new DataTransfer();
      files.forEach(file => dt.items.add(file));
      input.files = dt.files;

      // Update preview
      input.dispatchEvent(new Event('change'));
    }

    // Form submission
    document.getElementById('ratingForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';

      const formData = new FormData(this);

      try {
        const response = await fetch('/api/rate-with-images', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showAlert('success', result.message);
          // Reset form
          this.reset();
          document.getElementById('filePreview').innerHTML = '';
          // Reload page to show new rating
          setTimeout(() => location.reload(), 2000);
        } else {
          showAlert('error', result.error);
        }
      } catch (error) {
        showAlert('error', 'Network error. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    function showAlert(type, message) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>