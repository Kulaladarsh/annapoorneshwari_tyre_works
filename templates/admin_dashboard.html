<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Admin Dashboard - Annapoorneshwari Tyre & Painting Works</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    .stat-card {
      transition: transform 0.2s ease-in-out;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .revenue-highlight {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <nav class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('home') }}">Admin Dashboard</a>
      <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
      </button>
      <div class="d-none d-lg-flex">
        <ul class="navbar-nav flex-row">
          <li class="nav-item px-2"><a class="nav-link text-white" href="{{ url_for('home') }}">Home</a></li>
          <li class="nav-item px-2"><a class="nav-link text-white" href="{{ url_for('admin_logout') }}">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <a href="{{ url_for('home') }}" class="btn btn-link text-start mb-2">Home</a>
      <a href="{{ url_for('admin_logout') }}" class="btn btn-link text-start">Logout</a>
    </div>
  </div>

  <main class="container my-5 p-4 bg-white rounded shadow-sm" style="margin-top: 100px !important;">
    <h2 class="mb-4 text-center">Dashboard Overview</h2>
    
    <!-- Enhanced Statistics Cards -->
    <div class="row g-4 mb-5">
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-primary h-100">
          <div class="card-body text-center">
            <i class="fas fa-calendar-check fa-2x mb-2"></i>
            <h5 class="card-title">Total Bookings</h5>
            <p class="card-text fs-3">{{ total_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-success h-100">
          <div class="card-body text-center">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <h5 class="card-title">Completed</h5>
            <p class="card-text fs-3">{{ completed_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-warning h-100">
          <div class="card-body text-center">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <h5 class="card-title">Pending</h5>
            <p class="card-text fs-3">{{ pending_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white revenue-highlight h-100">
          <div class="card-body text-center">
            <i class="fas fa-rupee-sign fa-2x mb-2"></i>
            <h5 class="card-title">Total Revenue</h5>
            <p class="card-text fs-3">â‚¹{{ total_service_amount or 0 }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Statistics Row -->
    <div class="row g-4 mb-5">
      <div class="col-md-6">
        <div class="card stat-card text-white bg-info h-100">
          <div class="card-body text-center">
            <i class="fas fa-calendar-day fa-2x mb-2"></i>
            <h5 class="card-title">Today's Bookings</h5>
            <p class="card-text fs-3">{{ daily_prebookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card stat-card text-white bg-secondary h-100">
          <div class="card-body text-center">
            <i class="fas fa-star fa-2x mb-2"></i>
            <h5 class="card-title">Average Rating</h5>
            <p class="card-text fs-3">{{ average_rating or 'N/A' }}</p>
          </div>
        </div>
      </div>
    </div>

    <h3>Recent Bookings</h3>
    {% if prebookings %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th>Location</th>
            <th>Email</th>
            <th>Date & Time</th>
            <th>Services</th>
            <th>Vehicle</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for prebook in prebookings %}
          <tr>
            <td>{{ prebook.name }}</td>
            <td>
              <small>{{ prebook.contact }}</small>
            </td>
            <td>
              <small>{{ prebook.area }}<br>
              {{ prebook.district }}, {{ prebook.taluk }}</small>
            </td>
            <td>
              <small>{{ prebook.email }}</small>
            </td>
            <td>
              <small>{{ prebook.preferred_date or prebook.date }}<br>
              {{ prebook.time }}</small>
            </td>
            <td>
              {% for service in prebook.services %}
                <span class="badge bg-primary me-1">{{ service }}</span>
              {% endfor %}
            </td>
            <td>
              <small>{{ prebook.vehicle_type }}<br>
              {{ prebook.vehicle_details }}</small>
            </td>
            <td>
              {% if prebook.status == 'completed' %}
                <span class="badge bg-success">
                  <i class="fas fa-check"></i> Completed
                </span>
              {% else %}
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-clock"></i> Pending
                </span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group-vertical" role="group">
                {% if prebook.status != 'completed' %}
                  <button class="btn btn-success btn-sm mb-1" onclick="completeBooking('{{ prebook._id }}')" title="Mark as Completed">
                    <i class="fas fa-check"></i> Complete
                  </button>
                {% endif %}
                <a href="/receipt/{{ prebook.booking_id }}" class="btn btn-info btn-sm mb-1" title="View Receipt">
                  <i class="fas fa-receipt"></i> Receipt
                </a>
                <button class="btn btn-danger btn-sm" onclick="deleteItem('prebook', '{{ prebook._id }}')" title="Delete Booking">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
      <i class="fas fa-info-circle"></i> No bookings found.
    </div>
    {% endif %}


  <footer class="bg-light text-dark py-3 mt-auto shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
      <small>Â© 2025 Annapoorneshwari Tyre & Painting Works. All rights reserved.</small>
      <div>
        <small class="text-muted">Admin Panel v2.0</small>
      </div>
    </div>
  </footer>

  <script>
    async function deleteItem(type, id) {
      if (!confirm('Are you sure you want to delete this item?')) return;
      
      try {
        const res = await fetch(`/api/${type}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (res.ok) {
          alert("Deleted successfully");
          location.reload();
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (error) {
        alert("Network error: " + error.message);
      }
    }

    async function completeBooking(bookingId) {
      if (!confirm('Are you sure you want to mark this booking as completed?\n\nThis will:\n- Send a completion receipt to the customer\n- Allow them to rate the service\n- Add â‚¹20 to total revenue')) return;
      
      // Show loading state
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      button.disabled = true;
      
      try {
        const res = await fetch(`/admin/complete-booking/${bookingId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert("âœ… Booking marked as completed successfully!\nðŸ“§ Receipt sent to customer via email.");
          location.reload();
        } else {
          alert("âŒ Error: " + (data.error || "Failed to update booking"));
          button.innerHTML = originalText;
          button.disabled = false;
        }
      } catch (error) {
        alert("âŒ Network error: " + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // Auto-refresh dashboard every 30 seconds
    let autoRefresh = setInterval(() => {
      location.reload();
    }, 30000);

    // Pause auto-refresh when user is interacting
    document.addEventListener('click', () => {
      clearInterval(autoRefresh);
      autoRefresh = setInterval(() => location.reload(), 30000);
    });

    // Display loading message on page transitions
    window.addEventListener('beforeunload', function() {
      document.body.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 100vh;"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://