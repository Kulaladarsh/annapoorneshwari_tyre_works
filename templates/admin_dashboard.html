<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Admin Dashboard - Annapoorneshwari Tyre & Painting Works</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    .stat-card {
      transition: transform 0.2s ease-in-out;
    }
    .stat-card:hover {
      transform: translateY(-5px);
    }
    .revenue-highlight {
      background: linear-gradient(135deg, #28a745, #20c997);
    }
    .amount-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .amount-display {
      font-weight: bold;
      color: #28a745;
      font-size: 0.9rem;
    }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <nav class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('home') }}">Admin Dashboard</a>
      <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-label="Toggle menu">
        <i class="fas fa-bars"></i>
      </button>
      <div class="d-none d-lg-flex">
        <ul class="navbar-nav flex-row">
          <li class="nav-item px-2"><a class="nav-link text-white" href="{{ url_for('home') }}">Home</a></li>
          <li class="nav-item px-2"><a class="nav-link text-white" href="{{ url_for('admin_logout') }}">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarMenuLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <a href="{{ url_for('home') }}" class="btn btn-link text-start mb-2">Home</a>
      <a href="{{ url_for('admin_logout') }}" class="btn btn-link text-start">Logout</a>
    </div>
  </div>

  <main class="container my-5 p-4 bg-white rounded shadow-sm" style="margin-top: 100px !important;">
    <h2 class="mb-4 text-center">Dashboard Overview</h2>
    
    <!-- Enhanced Statistics Cards -->
    <div class="row g-4 mb-5">
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-primary h-100">
          <div class="card-body text-center">
            <i class="fas fa-calendar-check fa-2x mb-2"></i>
            <h5 class="card-title">Total Bookings</h5>
            <p class="card-text fs-3">{{ total_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-success h-100">
          <div class="card-body text-center">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <h5 class="card-title">Completed</h5>
            <p class="card-text fs-3">{{ completed_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white bg-warning h-100">
          <div class="card-body text-center">
            <i class="fas fa-clock fa-2x mb-2"></i>
            <h5 class="card-title">Pending</h5>
            <p class="card-text fs-3">{{ pending_bookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="card stat-card text-white revenue-highlight h-100">
          <div class="card-body text-center">
            <i class="fas fa-rupee-sign fa-2x mb-2"></i>
            <h5 class="card-title">Total Revenue</h5>
            <p class="card-text fs-3">‚Çπ{{ total_service_amount or 0 }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Statistics Row -->
    <div class="row g-4 mb-5">
      <div class="col-md-6">
        <div class="card stat-card text-white bg-info h-100">
          <div class="card-body text-center">
            <i class="fas fa-calendar-day fa-2x mb-2"></i>
            <h5 class="card-title">Today's Bookings</h5>
            <p class="card-text fs-3">{{ daily_prebookings or 0 }}</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card stat-card text-white bg-secondary h-100">
          <div class="card-body text-center">
            <i class="fas fa-star fa-2x mb-2"></i>
            <h5 class="card-title">Average Rating</h5>
            <p class="card-text fs-3">{{ average_rating or 'N/A' }}</p>
          </div>
        </div>
      </div>
    </div>

    <h3>Recent Bookings</h3>
    {% if prebookings %}
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th>Location</th>
            <th>Email</th>
            <th>Date & Time</th>
            <th>Services</th>
            <th>Vehicle</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for prebook in prebookings %}
          <tr>
            <td>{{ prebook.name }}</td>
            <td>
              <small>{{ prebook.contact }}</small>
            </td>
            <td>
              <small>{{ prebook.area }}<br>
              {{ prebook.district }}, {{ prebook.taluk }}</small>
            </td>
            <td>
              <small>{{ prebook.email }}</small>
            </td>
            <td>
              <small>{{ prebook.preferred_date or prebook.date }}<br>
              {{ prebook.time }}</small>
            </td>
            <td>
              {% for service in prebook.services %}
                <span class="badge bg-primary me-1">{{ service }}</span>
              {% endfor %}
            </td>
            <td>
              <small>{{ prebook.vehicle_type }}<br>
              {{ prebook.vehicle_details }}</small>
            </td>
            <td>
              <div id="amount-display-{{ prebook._id }}">
                {% if prebook.total_amount %}
                  <span class="amount-display">‚Çπ{{ prebook.total_amount }}</span>
                  <small class="text-muted d-block">(Service: ‚Çπ{{ prebook.service_amount or 0 }})</small>
                {% else %}
                  <span class="text-muted">Not set</span>
                {% endif %}
              </div>
            </td>
            <td>
              {% if prebook.status == 'completed' %}
                <span class="badge bg-success">
                  <i class="fas fa-check"></i> Completed
                </span>
              {% else %}
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-clock"></i> Pending
                </span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group-vertical" role="group">
                {% if prebook.status != 'completed' %}
                  <button class="btn btn-primary btn-sm mb-1" onclick="showAmountModal('{{ prebook._id }}', '{{ prebook.name }}')" title="Set Service Amount">
                    <i class="fas fa-rupee-sign"></i> Set Amount
                  </button>
                  <button class="btn btn-success btn-sm mb-1" onclick="completeWithAmount('{{ prebook._id }}')" title="Complete with Amount">
                    <i class="fas fa-check"></i> Complete
                  </button>
                {% endif %}
                <a href="/receipt/{{ prebook.booking_id }}" class="btn btn-info btn-sm mb-1" title="View Receipt">
                  <i class="fas fa-receipt"></i> Receipt
                </a>
                <button class="btn btn-danger btn-sm" onclick="deleteItem('prebook', '{{ prebook._id }}')" title="Delete Booking">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
      <i class="fas fa-info-circle"></i> No bookings found.
    </div>
    {% endif %}
  </main>

  <!-- Service Amount Modal -->
  <div class="modal fade" id="amountModal" tabindex="-1" aria-labelledby="amountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="amountModalLabel">
            <i class="fas fa-rupee-sign me-2"></i>Set Service Amount
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-3">Customer: <strong id="customerName"></strong></p>
          <input type="hidden" id="currentBookingId">
          
          <div class="mb-3">
            <label for="serviceAmount" class="form-label">Service Charges (‚Çπ)</label>
            <input type="number" class="form-control" id="serviceAmount" placeholder="Enter service amount" min="0" step="10" oninput="calculateTotal()">
            <small class="text-muted">Enter the actual service charges (excluding booking fee)</small>
          </div>
          
          <div class="alert alert-info">
            <div class="d-flex justify-content-between">
              <span>Service Charges:</span>
              <span id="serviceChargeDisplay">‚Çπ0</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Booking Fee:</span>
              <span>‚Çπ20</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold">
              <span>Total Amount:</span>
              <span id="totalAmountDisplay">‚Çπ20</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveServiceAmount()">
            <i class="fas fa-save me-1"></i>Save Amount
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-light text-dark py-3 mt-auto shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
      <small>¬© 2025 Annapoorneshwari Tyre & Painting Works. All rights reserved.</small>
      <div>
        <small class="text-muted">Admin Panel v2.0</small>
      </div>
    </div>
  </footer>

  <script>
    function showAmountModal(bookingId, customerName) {
      document.getElementById('currentBookingId').value = bookingId;
      document.getElementById('customerName').textContent = customerName;
      document.getElementById('serviceAmount').value = '';
      calculateTotal();
      
      const modal = new bootstrap.Modal(document.getElementById('amountModal'));
      modal.show();
    }

    function calculateTotal() {
      const serviceAmount = parseFloat(document.getElementById('serviceAmount').value) || 0;
      const bookingFee = 20;
      const total = serviceAmount + bookingFee;
      
      document.getElementById('serviceChargeDisplay').textContent = `‚Çπ${serviceAmount}`;
      document.getElementById('totalAmountDisplay').textContent = `‚Çπ${total}`;
    }

    async function saveServiceAmount() {
      const bookingId = document.getElementById('currentBookingId').value;
      const serviceAmount = parseFloat(document.getElementById('serviceAmount').value) || 0;
      
      if (serviceAmount < 0) {
        alert('Service amount cannot be negative');
        return;
      }
      
      try {
        const res = await fetch(`/admin/update-service-amount/${bookingId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ service_amount: serviceAmount })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`‚úÖ Amount updated successfully!\nTotal: ‚Çπ${data.total_amount}`);
          
          // Update the display without reloading
          const amountDisplay = document.getElementById(`amount-display-${bookingId}`);
          if (amountDisplay) {
            amountDisplay.innerHTML = `
              <span class="amount-display">‚Çπ${data.total_amount}</span>
              <small class="text-muted d-block">(Service: ‚Çπ${serviceAmount})</small>
            `;
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('amountModal')).hide();
        } else {
          alert('‚ùå Error: ' + (data.error || 'Failed to update amount'));
        }
      } catch (error) {
        alert('‚ùå Network error: ' + error.message);
      }
    }

    async function completeWithAmount(bookingId) {
      const serviceAmountInput = prompt('Enter service amount (‚Çπ) for this booking:\n(Booking fee of ‚Çπ20 will be added automatically)');
      
      if (serviceAmountInput === null) return; // User cancelled
      
      const serviceAmount = parseFloat(serviceAmountInput) || 0;
      
      if (serviceAmount < 0) {
        alert('Service amount cannot be negative');
        return;
      }
      
      const totalAmount = serviceAmount + 20;
      
      if (!confirm(`Confirm completion with amounts:\n\nService Charges: ‚Çπ${serviceAmount}\nBooking Fee: ‚Çπ20\nTotal Amount: ‚Çπ${totalAmount}\n\nThis will:\n- Mark booking as completed\n- Send final invoice to customer\n- Allow customer to rate the service`)) {
        return;
      }
      
      // Show loading state
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      button.disabled = true;
      
      try {
        const res = await fetch(`/admin/complete-booking/${bookingId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ service_amount: serviceAmount })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert(`‚úÖ Booking completed successfully!\nüìß Final invoice sent to customer\nTotal Amount: ‚Çπ${totalAmount}`);
          location.reload();
        } else {
          alert('‚ùå Error: ' + (data.error || 'Failed to complete booking'));
          button.innerHTML = originalText;
          button.disabled = false;
        }
      } catch (error) {
        alert('‚ùå Network error: ' + error.message);
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function deleteItem(type, id) {
      if (!confirm('Are you sure you want to delete this item?')) return;
      
      try {
        const res = await fetch(`/api/${type}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (res.ok) {
          alert("Deleted successfully");
          location.reload();
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (error) {
        alert("Network error: " + error.message);
      }
    }

    async function completeBooking(bookingId) {
      // Redirect to the new complete with amount function
      completeWithAmount(bookingId);
    }

    // Auto-refresh dashboard every 30 seconds
    let autoRefresh = setInterval(() => {
      location.reload();
    }, 30000);

    // Pause auto-refresh when user is interacting
    document.addEventListener('click', () => {
      clearInterval(autoRefresh);
      autoRefresh = setInterval(() => location.reload(), 30000);
    });

    // Display loading message on page transitions
    window.addEventListener('beforeunload', function() {
      document.body.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 100vh;"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>